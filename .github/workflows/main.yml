name: PC-V1

on:
  workflow_dispatch:

jobs:
  sunshine-moonlight:
    runs-on: windows-latest
    timeout-minutes: 4680

    steps:
      - name: Disable Sleep / Hibernate / PowerSave
        shell: powershell
        run: |
          powercfg /change standby-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /hibernate off
          powercfg /setactive SCHEME_MIN
          echo Disabled Sleep/Hibernate

      - name: Optimize Network for Streaming PC-V1
        shell: powershell
        run: |
          netsh interface tcp set global congestionprovider=ctcp
          netsh interface tcp set global rss=enabled
          netsh interface tcp set global ecncapability=enabled
          netsh int tcp set global autotuninglevel=experimental
          netsh interface tcp set global timestamps=disabled
          echo Network Streaming Optimization Applied

      - name: Configure Core PC-V1 Settings
        shell: powershell
        run: |
          Start-Process powershell -Verb runAs -ArgumentList @"
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -Force
            netsh advfirewall firewall add rule name='RDP-Allow' dir=in action=allow protocol=TCP localport=3389
            Restart-Service -Name TermService -Force
          "@

      - name: Create PC-V1 User
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Security
          $chars = ([char[]](33..126))
          $password = -join ($chars | Get-Random -Count 14)
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (-not (Get-LocalUser -Name "PC-V1" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "PC-V1" -Password $securePass -AccountNeverExpires
          }
          Add-LocalGroupMember -Group "Administrators" -Member "PC-V1"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "PC-V1"
          echo "RDP_USER=PC-V1" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Install Sunshine PC-V1 
        shell: powershell
        run: |
          $sunshinePath = "C:\Sunshine"
          $configDir = "$env:APPDATA\Sunshine"
          
          Get-Process -Name "sunshine" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          if (Test-Path $sunshinePath) {
              Remove-Item -Path $sunshinePath -Recurse -Force -ErrorAction SilentlyContinue
          }
          
          New-Item -Path $sunshinePath -ItemType Directory -Force
          New-Item -Path $configDir -ItemType Directory -Force
          
          echo "‚úÖ Directories created successfully"

      - name: Download and Extract Sunshine PC-V1 
        shell: powershell
        run: |
          $sunshinePath = "C:\Sunshine"
          
          echo "Downloading Sunshine..."
          try {
              $url = "https://github.com/LizardByte/Sunshine/releases/download/v0.23.0/sunshine-windows-portable.zip"
              $file = "$env:TEMP\sunshine.zip"
              
              Start-BitsTransfer -Source $url -Destination $file
              
              if (Test-Path $file) {
                  Expand-Archive -Path $file -DestinationPath $sunshinePath -Force
                  Remove-Item $file -Force
                  echo "‚úÖ Sunshine downloaded and extracted successfully"
              }
          } catch {
              echo "Download failed, trying alternative method..."
              try {
                  Invoke-WebRequest -Uri $url -OutFile $file -TimeoutSec 120
                  if (Test-Path $file) {
                      Expand-Archive -Path $file -DestinationPath $sunshinePath -Force
                      Remove-Item $file -Force
                      echo "‚úÖ Alternative download successful"
                  }
              } catch {
                  echo "‚ùå All download methods failed: $($_.Exception.Message)"
                  echo "@echo off" > "$sunshinePath\sunshine.bat"
                  echo "echo Sunshine placeholder - real installation failed" >> "$sunshinePath\sunshine.bat"
                  echo "timeout /nobreak > nul" >> "$sunshinePath\sunshine.bat"
              }
          }
          
          if (Test-Path "$sunshinePath\sunshine.exe") {
              echo "üéâ Sunshine installation verified"
              Get-ChildItem $sunshinePath | ForEach-Object { echo "  - $($_.Name)" }
          } else {
              echo "‚ö†Ô∏è Sunshine.exe not found, but continuing..."
          }

      - name: Install Tailscale PC-V1 
        shell: powershell
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $file = "$env:TEMP\tailscale.msi"
          try {
              Invoke-WebRequest -Uri $url -OutFile $file
              Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait
              Remove-Item $file -Force
              echo "Tailscale installed successfully"
          } catch {
              echo "Tailscale installation failed: $($_.Exception.Message)"
          }

      - name: Establish Tailscale Connection PC-V1 
        shell: powershell
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --hostname "PC-V1-Sunshine-${{ github.run_id }}"
          Start-Sleep -Seconds 10
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TS_IP=$tsIP" >> $env:GITHUB_ENV
          echo "Tailscale connected: $tsIP"

      - name: Configure Firewall for Sunshine
        shell: powershell
        run: |
          $ports = @(47984, 47989, 47990, 48010)
          
          foreach ($port in $ports) {
              netsh advfirewall firewall add rule name="Sunshine-$port-TCP" dir=in action=allow protocol=TCP localport=$port 2>&1 | Out-Null
              netsh advfirewall firewall add rule name="Sunshine-$port-UDP" dir=in action=allow protocol=UDP localport=$port 2>&1 | Out-Null
          }
          
          echo "Sunshine firewall rules configured"

      - name: Start Sunshine Application PC-V1 
        shell: powershell
        run: |
          $sunshinePath = "C:\Sunshine"
          $sunshineExe = "$sunshinePath\sunshine.exe"
          
          echo "Starting Sunshine application..."
          
          Get-Process -Name "sunshine" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          
          if (Test-Path $sunshineExe) {
              try {
                  Set-Location -Path $sunshinePath
                  
                  $job = Start-Job -ScriptBlock {
                      Set-Location $using:sunshinePath
                      & ".\sunshine.exe"
                  }
                  
                  Start-Sleep -Seconds 10

                  $sunshineProcess = Get-Process -Name "sunshine" -ErrorAction SilentlyContinue
                  if ($sunshineProcess) {
                      echo "SUNSHINE_PID=$($sunshineProcess.Id)" >> $env:GITHUB_ENV
                      echo "‚úÖ Sunshine started successfully with PID: $($sunshineProcess.Id)"
                      echo "‚úÖ Sunshine is running as process"
                  } else {
                      echo "‚ö†Ô∏è Sunshine process not found after startup attempt"
                      echo "Trying alternative startup method..."
                      
                      $process = Start-Process -FilePath $sunshineExe -WindowStyle Hidden -PassThru
                      Start-Sleep -Seconds 5
                      
                      if ($process -and !$process.HasExited) {
                          echo "SUNSHINE_PID=$($process.Id)" >> $env:GITHUB_ENV
                          echo "‚úÖ Sunshine started with alternative method, PID: $($process.Id)"
                      } else {
                          echo "‚ùå Sunshine failed to start with both methods"
                      }
                  }
                  
              } catch {
                  echo "‚ùå Error starting Sunshine: $($_.Exception.Message)"
              }
          } else {
              echo "‚ö†Ô∏è Sunshine executable not found at: $sunshineExe"
              echo "Continuing workflow without Sunshine..."
          }
          
          echo "‚úÖ Step completed (Sunshine start attempted)"

      - name: PC-V1 Port Configuration
        shell: powershell
        run: |
          $randomPort = Get-Random -Minimum 10000 -Maximum 65535
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'PortNumber' -Value $randomPort -Force
          
          netsh advfirewall firewall add rule name="PC-V1-Random-$randomPort" dir=in action=allow protocol=TCP localport=$randomPort 2>&1 | Out-Null
          
          Restart-Service -Name TermService -Force
          echo "PC-V1_PORT=$randomPort" >> $env:GITHUB_ENV
          echo "PC-V1 port set to: $randomPort"

      - name: Verify Services and Connectivity
        shell: powershell
        run: |
          echo "=== Service Status ==="
          
          $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
          if ($rdpService -and $rdpService.Status -eq 'Running') {
              echo "‚úÖ PC-V1 Service: RUNNING"
          } else {
              echo "‚ùå PC-V1 Service: NOT RUNNING"
          }
          
          $sunshineProcess = Get-Process -Name "sunshine" -ErrorAction SilentlyContinue
          if ($sunshineProcess) {
              echo "‚úÖ Sunshine Process: RUNNING (PID: $($sunshineProcess.Id))"
              
              try {
                  $response = Invoke-WebRequest -Uri "http://localhost:47989" -TimeoutSec 5 -ErrorAction SilentlyContinue
                  echo "‚úÖ Sunshine Web Interface: ACCESSIBLE"
              } catch {
                  echo "‚ö†Ô∏è Sunshine Web Interface: Not responding (may need more time)"
              }
          } else {
              echo "‚ö†Ô∏è Sunshine Process: NOT RUNNING"
          }
          
          $tsIP = $env:TS_IP
          if ($tsIP) {
              echo "üåê Tailscale IP: $tsIP"
              
              try {
                  $ping = Test-NetConnection -ComputerName $tsIP -Port 3389 -WarningAction SilentlyContinue
                  if ($ping.TcpTestSucceeded) {
                      echo "‚úÖ Tailscale RDP Port: REACHABLE"
                  } else {
                      echo "‚ö†Ô∏è Tailscale PC-V1 Port: Not reachable"
                  }
              } catch {
                  echo "‚ö†Ô∏è Tailscale connectivity test failed"
              }
          }

      - name: Create Connection Monitor PC-V1
        shell: powershell
        run: |
          $monitorScript = @'
          while ($true) {
              try {
                  $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                  
                  $sunshine = Get-Process -Name "sunshine" -ErrorAction SilentlyContinue
                  if (-not $sunshine) {
                      Write-Host "[$timestamp] Sunshine not running - attempting to start..."
                      if (Test-Path "C:\Sunshine\sunshine.exe") {
                          Start-Process -FilePath "C:\Sunshine\sunshine.exe" -WindowStyle Hidden
                          Start-Sleep -Seconds 10
                      }
                  } else {
                      Write-Host "[$timestamp] Sunshine OK (PID: $($sunshine.Id))"
                  }
                  
                  $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                  if ($rdpService.Status -ne 'Running') {
                      Write-Host "[$timestamp] RDP Service stopped - restarting..."
                      Start-Service -Name "TermService" -ErrorAction SilentlyContinue
                  }
                  
                  $tailscale = Get-Process -Name "tailscale" -ErrorAction SilentlyContinue
                  if (-not $tailscale) {
                      Write-Host "[$timestamp] Tailscale not running"
                  }
                  
              } catch {
                  Write-Host "[$timestamp] Monitor error: $_"
              }
              
              Start-Sleep -Seconds 30
          }

          $scriptPath = "$env:ProgramData\sunshine-monitor.ps1"
          try {
              $monitorScript | Out-File -FilePath $scriptPath -Encoding utf8
              echo "‚úÖ Monitor script created at: $scriptPath"
          } catch {
              echo "‚ö†Ô∏è Failed to create monitor script: $_"
          }
          
          try {
              $powershellProcess = Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File `"$scriptPath`"" -WindowStyle Hidden -PassThru
              if ($powershellProcess) {
                  echo "‚úÖ Background monitor started with PID: $($powershellProcess.Id)"
              } else {
                  echo "‚ö†Ô∏è Background monitor start attempted but PID not captured"
              }
          } catch {
              echo "‚ö†Ô∏è Failed to start background monitor: $_"
          }
          
          echo "‚úÖ Connection Monitor setup completed successfully"

      - name: Display Connection Information
        shell: powershell
        run: |
          $tsIP = $env:TS_IP
          $rdpPort = $env:RDP_PORT
          
          Write-Host ""
          Write-Host "==========================="
          Write-Host "üéÆ PC-V1 MOONLIGHT"
          Write-Host "==========================="
          Write-Host ""
          Write-Host "üåê Connection Details:"
          Write-Host "   Sunshine Host: $tsIP"
          Write-Host "   Sunshine Port: 47989"
          Write-Host "   PC-V1 Access: $tsIP`:$rdpPort"
          Write-Host ""
          Write-Host "üë§ Login Credentials:"
          Write-Host "   Username: $env:RDP_USER" 
          Write-Host "   Password: $env:RDP_PASS"
          Write-Host ""
          Write-Host "üì± Moonlight Setup:"
          Write-Host "   1. Install Moonlight app"
          Write-Host "   2. Add PC: $tsIP"
          Write-Host "   3. Web UI: https://$tsIP`:47989"
          Write-Host ""
          Write-Host "‚ö° Status:"
          $sunshineStatus = if (Get-Process -Name "sunshine" -ErrorAction SilentlyContinue) { "‚úÖ RUNNING" } else { "‚ùå STOPPED" }
          Write-Host "   Sunshine: $sunshineStatus"
          Write-Host "   Tailscale: ‚úÖ CONNECTED"
          Write-Host "   PC-V1: ‚úÖ ENABLED"
          Write-Host ""
          Write-Host "==========================="

      - name: Maintain Active Session (Simple Keepalive)
        shell: powershell
        run: |
          $tsIP = $env:TS_IP
          $startTime = Get-Date
          $errorCount = 0
          
          Write-Host "üîÑ Active Session Maintenance Started..."
          Write-Host "üì° Tailscale IP: $tsIP"
          Write-Host "‚è∞ Start Time: $startTime"
          Write-Host ""
          
          while ($true) {
              try {
                  $currentTime = Get-Date
                  $uptime = $currentTime - $startTime
                  $hours = [math]::Floor($uptime.TotalHours)
                  $minutes = [math]::Floor($uptime.TotalMinutes) % 60
                  
                  $sunshineProcess = Get-Process -Name "sunshine" -ErrorAction SilentlyContinue
                  $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                  $tailscaleProcess = Get-Process -Name "tailscale" -ErrorAction SilentlyContinue
                  
                  $sunshineStatus = if ($sunshineProcess) { "‚úÖ" } else { "‚ùå" }
                  $rdpStatus = if ($rdpService -and $rdpService.Status -eq 'Running') { "‚úÖ" } else { "‚ùå" }
                  $tailscaleStatus = if ($tailscaleProcess) { "‚úÖ" } else { "‚ùå" }
                  
                  Write-Host "[$($currentTime.ToString('HH:mm:ss'))] Uptime: ${hours}h ${minutes}m | Sunshine: $sunshineStatus | RDP: $rdpStatus | Tailscale: $tailscaleStatus | IP: $tsIP"
                  
                  if (-not $sunshineProcess -and $errorCount -lt 3) {
                      Write-Host "   ‚Ü≥ Attempting to restart Sunshine..."
                      if (Test-Path "C:\Sunshine\sunshine.exe") {
                          $newProcess = Start-Process -FilePath "C:\Sunshine\sunshine.exe" -WindowStyle Hidden -PassThru
                          if ($newProcess) {
                              Write-Host "   ‚Ü≥ Sunshine restarted with PID: $($newProcess.Id)"
                              $errorCount = 0
                          } else {
                              $errorCount++
                              Write-Host "   ‚Ü≥ Sunshine restart failed (attempt $errorCount/3)"
                          }
                      }
                  }
                  
                  if ($sunshineProcess -and $rdpService -and $rdpService.Status -eq 'Running') {
                      if ($errorCount > 0) { $errorCount = 0 }
                  }
                  
              } catch {
                  Write-Host "   ‚ö†Ô∏è Maintenance Error: $_"
                  $errorCount++
              }
              
              Start-Sleep -Seconds 60
          }