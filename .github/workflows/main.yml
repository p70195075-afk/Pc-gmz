name: PC-V1 Moonlight

on:
  workflow_dispatch:

jobs:
  sunshine-moonlight:
    runs-on: windows-latest
    timeout-minutes: 4680

    steps:
      - name: Disable Sleep / Hibernate / PowerSave
        shell: powershell
        run: |
          powercfg /change standby-timeout-ac 0
          powercfg /change monitor-timeout-ac 0
          powercfg /hibernate off
          powercfg /setactive SCHEME_MIN
          echo "‚úÖ Disabled Sleep/Hibernate"

      - name: Optimize Network for Streaming
        shell: powershell
        run: |
          netsh interface tcp set global congestionprovider=ctcp
          netsh interface tcp set global rss=enabled
          netsh interface tcp set global ecncapability=enabled
          netsh int tcp set global autotuninglevel=experimental
          netsh interface tcp set global timestamps=disabled
          echo "‚úÖ Network Streaming Optimization Applied"

      - name: Configure Core Settings
        shell: powershell
        run: |
          Start-Process powershell -Verb runAs -ArgumentList @"
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -Force
            netsh advfirewall firewall add rule name='RDP-Allow' dir=in action=allow protocol=TCP localport=3389
            Restart-Service -Name TermService -Force
          "@
          echo "‚úÖ Core settings configured"

      - name: Create User Account
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Security
          $chars = ([char[]](33..126))
          $password = -join ($chars | Get-Random -Count 14)
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Remove existing user if any
          $existingUser = Get-LocalUser -Name "StreamUser" -ErrorAction SilentlyContinue
          if ($existingUser) {
              Remove-LocalUser -Name "StreamUser" -ErrorAction SilentlyContinue
          }
          
          # Create new user
          New-LocalUser -Name "StreamUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "StreamUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "StreamUser"
          
          echo "STREAM_USER=StreamUser" >> $env:GITHUB_ENV
          echo "STREAM_PASS=$password" >> $env:GITHUB_ENV
          echo "‚úÖ User account created"

      - name: Setup Sunshine Directory
        shell: powershell
        run: |
          $sunshinePath = "C:\Sunshine"
          $configDir = "$env:APPDATA\Sunshine"
          
          # Stop any running Sunshine processes
          Get-Process -Name "sunshine" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          
          # Clean and create directories
          if (Test-Path $sunshinePath) {
              Remove-Item -Path $sunshinePath -Recurse -Force -ErrorAction SilentlyContinue
          }
          
          New-Item -Path $sunshinePath -ItemType Directory -Force
          New-Item -Path $configDir -ItemType Directory -Force
          
          echo "SUNSHINE_PATH=$sunshinePath" >> $env:GITHUB_ENV
          echo "‚úÖ Sunshine directories created"

      - name: Download and Install Sunshine
        shell: powershell
        run: |
          $sunshinePath = $env:SUNSHINE_PATH
          $sunshineUrl = "https://github.com/LizardByte/Sunshine/releases/download/v0.23.0/sunshine-windows-portable.zip"
          $zipFile = "$env:TEMP\sunshine-latest.zip"
          
          echo "Downloading Sunshine..."
          try {
              # Download using multiple methods for reliability
              $progressPreference = 'SilentlyContinue'
              Invoke-WebRequest -Uri $sunshineUrl -OutFile $zipFile -TimeoutSec 120
              
              if (Test-Path $zipFile) {
                  echo "Extracting Sunshine..."
                  Expand-Archive -Path $zipFile -DestinationPath $sunshinePath -Force
                  Remove-Item $zipFile -Force
                  echo "‚úÖ Sunshine downloaded and extracted"
              } else {
                  throw "Download failed"
              }
          }
          catch {
              echo "‚ùå Download failed: $($_.Exception.Message)"
              # Create placeholder to continue workflow
              echo "@echo off" > "$sunshinePath\sunshine.bat"
              echo "echo Sunshine placeholder" >> "$sunshinePath\sunshine.bat"
              echo "timeout /t 300" >> "$sunshinePath\sunshine.bat"
          }
          
          # Verify installation
          if (Test-Path "$sunshinePath\sunshine.exe") {
              echo "üéâ Sunshine executable verified"
              Get-ChildItem $sunshinePath | ForEach-Object { echo "  - $($_.Name)" }
          } else {
              echo "‚ö†Ô∏è Sunshine.exe not found, but continuing..."
          }

      - name: Install and Configure Tailscale
        shell: powershell
        run: |
          # Install Tailscale
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $file = "$env:TEMP\tailscale.msi"
          try {
              echo "Downloading Tailscale..."
              Invoke-WebRequest -Uri $url -OutFile $file -TimeoutSec 60
              
              echo "Installing Tailscale..."
              $process = Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait -PassThru
              
              if ($process.ExitCode -eq 0) {
                  echo "‚úÖ Tailscale installed successfully"
              } else {
                  echo "‚ö†Ô∏è Tailscale installation exit code: $($process.ExitCode)"
              }
              
              if (Test-Path $file) {
                  Remove-Item $file -Force
              }
              
              Start-Sleep -Seconds 10
              
          } catch {
              echo "‚ùå Tailscale installation failed: $($_.Exception.Message)"
              exit 1
          }

          # Wait for Tailscale service
          echo "Waiting for Tailscale service..."
          $maxAttempts = 10
          $attempt = 0
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          $serviceReady = $false
          
          while ($attempt -lt $maxAttempts) {
              $attempt++
              echo "Attempt $attempt of $maxAttempts..."
              
              if (Test-Path $tailscaleExe) {
                  echo "‚úÖ Tailscale executable found"
                  
                  $service = Get-Service -Name "Tailscale" -ErrorAction SilentlyContinue
                  if ($service -and $service.Status -eq 'Running') {
                      echo "‚úÖ Tailscale service is running"
                      
                      $testResult = & $tailscaleExe version 2>&1
                      if ($LASTEXITCODE -eq 0) {
                          echo "‚úÖ Tailscale command test successful"
                          $serviceReady = $true
                          break
                      } else {
                          echo "‚ö†Ô∏è Tailscale command test failed, retrying..."
                      }
                  } else {
                      echo "‚ö†Ô∏è Tailscale service not running, attempting to start..."
                      try {
                          Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
                          Start-Sleep -Seconds 5
                      } catch {
                          echo "Service start attempt failed"
                      }
                  }
              } else {
                  echo "‚ö†Ô∏è Tailscale executable not found yet"
              }
              
              Start-Sleep -Seconds 5
          }

          # Establish Tailscale connection
          if (-not (Test-Path $tailscaleExe)) {
              echo "‚ùå Tailscale executable not found"
              exit 1
          }
          
          echo "Starting Tailscale connection..."
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          if ([string]::IsNullOrEmpty($authKey)) {
              echo "‚ùå TAILSCALE_AUTH_KEY secret is not set"
              exit 1
          }
          
          & $tailscaleExe up --authkey $authKey --hostname "Moonlight-PC-${{ github.run_id }}"
          
          if ($LASTEXITCODE -ne 0) {
              echo "‚ùå Tailscale up failed, trying with reset..."
              & $tailscaleExe logout
              Start-Sleep -Seconds 2
              & $tailscaleExe up --authkey $authKey --hostname "Moonlight-PC-${{ github.run_id }}" --reset
          }
          
          Start-Sleep -Seconds 10
          
          # Get Tailscale IP
          echo "Getting Tailscale IP..."
          $tsIP = & $tailscaleExe ip -4
          if ($LASTEXITCODE -eq 0 -and -not [string]::IsNullOrEmpty($tsIP)) {
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              echo "‚úÖ Tailscale connected: $tsIP"
          } else {
              $tsStatus = & $tailscaleExe status --json | ConvertFrom-Json
              if ($tsStatus -and $tsStatus.Self -and $tsStatus.Self.TailscaleIPs) {
                  $tsIP = $tsStatus.Self.TailscaleIPs[0]
                  echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                  echo "‚úÖ Tailscale connected (via JSON): $tsIP"
              } else {
                  echo "‚ö†Ô∏è Could not get Tailscale IP"
                  echo "TAILSCALE_IP=unknown" >> $env:GITHUB_ENV
              }
          }

      - name: Configure Firewall for Sunshine
        shell: powershell
        run: |
          $ports = @(47984, 47989, 47990, 48010)
          
          foreach ($port in $ports) {
              # Remove existing rules
              netsh advfirewall firewall delete rule name="Sunshine-$port-TCP" 2>&1 | Out-Null
              netsh advfirewall firewall delete rule name="Sunshine-$port-UDP" 2>&1 | Out-Null
              
              # Add new rules
              netsh advfirewall firewall add rule name="Sunshine-$port-TCP" dir=in action=allow protocol=TCP localport=$port 2>&1 | Out-Null
              netsh advfirewall firewall add rule name="Sunshine-$port-UDP" dir=in action=allow protocol=UDP localport=$port 2>&1 | Out-Null
          }
          
          echo "‚úÖ Sunshine firewall rules configured"

      - name: Generate Sunshine Configuration
        shell: powershell
        run: |
          $configDir = "$env:APPDATA\Sunshine"
          $configFile = "$configDir\sunshine.conf"
          
          # Basic Sunshine configuration
          $configContent = @'
# Sunshine Configuration for Moonlight
# Auto-generated by GitHub Actions

{
  "global": {
    "gamepad": "x360",
    "upnp": false,
    "origin_web_ui_allowed": "pc",
    "min_log_level": 2
  },
  "apps": [
    {
      "name": "Desktop",
      "output": "",
      "cmd": "explorer.exe",
      "detached": [
        "explorer.exe"
      ]
    }
  ],
  "nvhttp": {
    "port": 47989,
    "pin": "123456",
    "pkey": "sunshine.pem",
    "cert": "sunshine.crt"
  }
}
'@
          
          # Write configuration
          $configContent | Out-File -FilePath $configFile -Encoding utf8
          echo "‚úÖ Sunshine configuration generated"

      - name: Start Sunshine Service
        shell: powershell
        run: |
          $sunshinePath = $env:SUNSHINE_PATH
          $sunshineExe = "$sunshinePath\sunshine.exe"
          
          echo "Starting Sunshine service..."
          
          # Kill any existing Sunshine processes
          Get-Process -Name "sunshine" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          
          if (Test-Path $sunshineExe) {
              try {
                  # Start Sunshine in background
                  $process = Start-Process -FilePath $sunshineExe -WindowStyle Hidden -PassThru
                  
                  if ($process -and !$process.HasExited) {
                      echo "SUNSHINE_PID=$($process.Id)" >> $env:GITHUB_ENV
                      echo "‚úÖ Sunshine started with PID: $($process.Id)"
                      
                      # Wait for Sunshine to initialize
                      echo "Waiting for Sunshine to initialize..."
                      Start-Sleep -Seconds 15
                      
                      # Test if Sunshine web interface is accessible
                      try {
                          $response = Invoke-WebRequest -Uri "http://localhost:47989" -TimeoutSec 10 -ErrorAction SilentlyContinue
                          echo "‚úÖ Sunshine web interface is accessible"
                      } catch {
                          echo "‚ö†Ô∏è Sunshine web interface not responding yet: $($_.Exception.Message)"
                      }
                  } else {
                      echo "‚ùå Failed to start Sunshine process"
                  }
              } catch {
                  echo "‚ùå Error starting Sunshine: $($_.Exception.Message)"
              }
          } else {
              echo "‚ö†Ô∏è Sunshine executable not found at: $sunshineExe"
          }

     