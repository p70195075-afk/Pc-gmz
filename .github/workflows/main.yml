name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        shell: powershell
        run: |
          Write-Host "ğŸ”„ Configuring RDP settings..."
          
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable Network Level Authentication for broader compatibility
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # Configure firewall - remove existing rule first
          Write-Host "ğŸ”§ Configuring firewall..."
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>&1 | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          # Restart Terminal Service
          Write-Host "ğŸ”„ Restarting Terminal Service..."
          Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue
          
          Write-Host "âœ… RDP configuration completed successfully"

      - name: Create RDP User with Secure Password
        shell: powershell
        run: |
          Write-Host "ğŸ‘¤ Creating RDP user..."
          
          # Check if user already exists and delete if it does
          $existingUser = Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
          if ($existingUser) {
              Write-Host "ğŸ”„ Removing existing RDP user..."
              Remove-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 2
          }

          # Generate secure password
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
          }
          
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 3
          $rawPassword += $charSet.Lower | Get-Random -Count 3
          $rawPassword += $charSet.Number | Get-Random -Count 3
          $rawPassword += $charSet.Special | Get-Random -Count 3
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          # Create user with better error handling
          try {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -ErrorAction Stop
              Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction Stop
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction Stop
              
              Write-Host "âœ… User created successfully"
              echo "RDP_USER=RDP" >> $env:GITHUB_ENV
              echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          }
          catch {
              Write-Host "âŒ User creation failed: $($_.Exception.Message)"
              # Try alternative approach
              try {
                  net user RDP $password /add /y /expires:never
                  net localgroup administrators RDP /add
                  net localgroup "Remote Desktop Users" RDP /add
                  Write-Host "âœ… User created using alternative method"
                  echo "RDP_USER=RDP" >> $env:GITHUB_ENV
                  echo "RDP_PASS=$password" >> $env:GITHUB_ENV
              }
              catch {
                  Write-Host "âŒ All user creation methods failed"
                  exit 1
              }
          }

          # Verify user was created
          if (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue) {
              Write-Host "âœ… User verification successful"
          } else {
              Write-Host "âŒ User creation verification failed"
              exit 1
          }

      - name: Install Tailscale
        shell: powershell
        run: |
          Write-Host "ğŸ“¥ Installing Tailscale..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
         
          try {
              # Download Tailscale with retry logic
              $retryCount = 0
              $maxRetries = 3
              while ($retryCount -lt $maxRetries) {
                  try {
                      Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -TimeoutSec 60
                      break
                  }
                  catch {
                      $retryCount++
                      if ($retryCount -eq $maxRetries) {
                          throw
                      }
                      Write-Host "âš ï¸ Download failed, retrying... ($retryCount/$maxRetries)"
                      Start-Sleep -Seconds 5
                  }
              }
              
              # Install silently with better process handling
              $process = Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -PassThru
              
              if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
                  Write-Host "âœ… Tailscale installed successfully (Exit code: $($process.ExitCode))"
              } else {
                  Write-Host "âš ï¸ Tailscale installation completed with exit code: $($process.ExitCode)"
              }
              
              # Cleanup
              if (Test-Path $installerPath) {
                  Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              }
              
              # Wait for installation to complete and service to start
              Write-Host "ğŸ”„ Waiting for Tailscale service to start..."
              Start-Sleep -Seconds 15
              
              # Ensure Tailscale service is running
              $service = Get-Service -Name "Tailscale" -ErrorAction SilentlyContinue
              if ($service) {
                  if ($service.Status -ne 'Running') {
                      Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
                      Start-Sleep -Seconds 5
                  }
                  Write-Host "âœ… Tailscale service is running"
              }
          }
          catch {
              Write-Host "âŒ Tailscale installation failed: $($_.Exception.Message)"
              exit 1
          }

      - name: Establish Tailscale Connection
        shell: powershell
        run: |
          Write-Host "ğŸ”— Establishing Tailscale connection..."
          
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          
          # Wait for Tailscale to be ready with timeout
          $maxAttempts = 15
          $attempt = 0
          while ($attempt -lt $maxAttempts) {
              $attempt++
              if (Test-Path $tailscaleExe) {
                  Write-Host "âœ… Tailscale executable found"
                  break
              }
              Write-Host "â³ Waiting for Tailscale... Attempt $attempt/$maxAttempts"
              Start-Sleep -Seconds 3
          }
          
          if (-not (Test-Path $tailscaleExe)) {
              Write-Host "âŒ Tailscale executable not found after $maxAttempts attempts"
              exit 1
          }

          # Check if auth key is set
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          if ([string]::IsNullOrEmpty($authKey)) {
              Write-Host "âŒ TAILSCALE_AUTH_KEY secret is not set"
              Write-Host "ğŸ’¡ Please add your Tailscale auth key to repository secrets"
              exit 1
          }

          # Connect to Tailscale with retry logic
          Write-Host "ğŸ”„ Connecting to Tailscale network..."
          $connectAttempts = 0
          $maxConnectAttempts = 3
          
          while ($connectAttempts -lt $maxConnectAttempts) {
              & $tailscaleExe up --authkey=$authKey --hostname=gh-runner-$env:GITHUB_RUN_ID --accept-routes
              
              if ($LASTEXITCODE -eq 0) {
                  Write-Host "âœ… Tailscale connected successfully"
                  break
              } else {
                  $connectAttempts++
                  if ($connectAttempts -eq $maxConnectAttempts) {
                      Write-Host "âŒ Tailscale connection failed after $maxConnectAttempts attempts"
                      exit 1
                  }
                  Write-Host "âš ï¸ Tailscale connection failed, retrying... ($connectAttempts/$maxConnectAttempts)"
                  Start-Sleep -Seconds 10
              }
          }

          # Get Tailscale IP with better handling
          Write-Host "ğŸŒ Getting Tailscale IP address..."
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 12) {
              $tsIP = & $tailscaleExe ip -4
              if ([string]::IsNullOrEmpty($tsIP)) {
                  Write-Host "â³ Waiting for Tailscale IP... ($($retries + 1)/12)"
                  Start-Sleep -Seconds 5
                  $retries++
              }
          }

          if ([string]::IsNullOrEmpty($tsIP)) {
              Write-Host "âŒ Tailscale IP not assigned after $retries attempts"
              Write-Host "ğŸ” Checking Tailscale status..."
              & $tailscaleExe status
              exit 1
          }

          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ… Tailscale connected with IP: $tsIP"

      - name: Verify RDP Accessibility
        shell: powershell
        run: |
          Write-Host "ğŸ” Verifying RDP accessibility..."
          Write-Host "ğŸŒ Tailscale IP: $env:TAILSCALE_IP"

          # Test connectivity with better error handling
          try {
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue -ErrorAction SilentlyContinue
              
              if ($testResult.TcpTestSucceeded) {
                  Write-Host "âœ… TCP connection to RDP port 3389 successful!"
              } else {
                  Write-Host "âš ï¸ TCP connection test failed, but continuing..."
                  Write-Host "ğŸ’¡ This might be normal in some network configurations"
              }
          }
          catch {
              Write-Host "âš ï¸ Connectivity test error: $($_.Exception.Message)"
              Write-Host "ğŸ’¡ Continuing despite connectivity test issues..."
          }

      - name: Display Connection Information
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "ğŸš€ RDP ACCESS CONFIGURED SUCCESSFULLY"
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "ğŸŒ CONNECTION DETAILS:"
          Write-Host "   IP Address: $env:TAILSCALE_IP"
          Write-Host "   Port: 3389"
          Write-Host ""
          Write-Host "ğŸ‘¤ LOGIN CREDENTIALS:"
          Write-Host "   Username: $env:RDP_USER"
          Write-Host "   Password: $env:RDP_PASS"
          Write-Host ""
          Write-Host "ğŸ“ INSTRUCTIONS:"
          Write-Host "   1. Open Remote Desktop Connection (mstsc.exe)"
          Write-Host "   2. Enter: $env:TAILSCALE_IP"
          Write-Host "   3. Use credentials above when prompted"
          Write-Host ""
          Write-Host "ğŸ”§ TROUBLESHOOTING:"
          Write-Host "   â€¢ Ensure Tailscale is installed on your client device"
          Write-Host "   â€¢ Make sure you're logged into the same Tailscale network"
          Write-Host "   â€¢ Check firewall settings if connection fails"
          Write-Host ""
          Write-Host "â° This session will remain active for up to 60 minutes"
          Write-Host "=========================================="
          Write-Host ""

      - name: Maintain Connection
        shell: powershell
        run: |
          Write-Host "ğŸ› ï¸ Starting connection maintenance..."
          $startTime = Get-Date
          $errorCount = 0
          $maxErrors = 10
          
          Write-Host "â° Start Time: $startTime"
          Write-Host "ğŸ“¡ Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "ğŸ”§ Monitoring services..."
          
          while ($errorCount -lt $maxErrors) {
              try {
                  $currentTime = Get-Date
                  $uptime = $currentTime - $startTime
                  $hours = [math]::Floor($uptime.TotalHours)
                  $minutes = [math]::Floor($uptime.TotalMinutes) % 60
                  
                  # Check if Tailscale is still connected
                  $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
                  $isConnected = $false
                  
                  if (Test-Path $tailscaleExe) {
                      $tsStatus = & $tailscaleExe status --json 2>&1 | ConvertFrom-Json -ErrorAction SilentlyContinue
                      if ($tsStatus -and $tsStatus.BackendState -eq "Running") {
                          $currentIP = & $tailscaleExe ip -4 2>&1
                          if (-not [string]::IsNullOrEmpty($currentIP)) {
                              $isConnected = $true
                              Write-Host "[$($currentTime.ToString('HH:mm:ss'))] âœ… Active - Uptime: ${hours}h ${minutes}m - IP: $currentIP"
                              $errorCount = 0
                          }
                      }
                  }
                  
                  if (-not $isConnected) {
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] âš ï¸ Connection issue detected"
                      $errorCount++
                      
                      # Attempt to reconnect
                      if ($errorCount -gt 3) {
                          Write-Host "   ğŸ”„ Attempting to reconnect Tailscale..."
                          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
                          & $tailscaleExe up --authkey=$authKey --reset --accept-routes
                          Start-Sleep -Seconds 10
                          
                          # Check if reconnection was successful
                          $newIP = & $tailscaleExe ip -4 2>&1
                          if (-not [string]::IsNullOrEmpty($newIP)) {
                              Write-Host "   âœ… Reconnected successfully - New IP: $newIP"
                              $errorCount = 0
                              echo "TAILSCALE_IP=$newIP" >> $env:GITHUB_ENV
                          }
                      }
                  }
                  
                  # Sleep for 30 seconds before next check
                  Start-Sleep -Seconds 30
              }
              catch {
                  Write-Host "   âŒ Maintenance error: $($_.Exception.Message)"
                  $errorCount++
                  Start-Sleep -Seconds 30
              }
          }
          
          Write-Host "âŒ Too many errors encountered. Maintenance stopping."
          Write-Host "ğŸ“Š Final Stats - Total Uptime: $hours hours $minutes minutes"
          Write-Host "ğŸ‘‹ Session ended"
